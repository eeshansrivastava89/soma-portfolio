---
import SiteLayout from '../../../shared/src/layouts/SiteLayout.astro'
import LearningsTimeline from '../components/LearningsTimeline'
import ProjectCard from '../../../shared/src/components/ProjectCard.astro'
import { validateBuildLogData } from '../lib/validate-build-log'
import { parseLearningsYaml, getLearnings } from '../../../shared/src/lib/learnings'
import { parseProjectsYaml } from '../../../shared/src/lib/projects'

// Import YAML as raw string (Vite handles this)
import learningsYaml from '../../../shared/src/data/learnings.yaml?raw'
import projectsYaml from '../../../shared/src/data/projects.yaml?raw'

// Data source (overwritten by fetch script). Keep defaults for local preview.
import buildLogData from '../data/build-log-data.json'

const validatedData = validateBuildLogData(buildLogData)
if (!validatedData) {
	throw new Error('Invalid build-log-data.json. Run: npm run fetch:data')
}

const { tasks, contributors } = validatedData

// Load learnings from YAML
const allLearnings = getLearnings(parseLearningsYaml(learningsYaml))

// Load projects from YAML
const projects = parseProjectsYaml(projectsYaml)

// Compute stats for contribute CTA
const totalContributors = contributors.length
const openCount = tasks.filter(t => t.status === 'open').length
---

<SiteLayout meta={{ title: 'The Build Log' }}>
	<div class='w-full space-y-12'>

		<!-- ============================================ -->
		<!-- HERO: Solo-first messaging                   -->
		<!-- ============================================ -->
		<section class='space-y-4'>
			<p class='text-xs font-semibold uppercase tracking-[0.3em] text-primary'>The Build Log</p>
			
			<div class='space-y-4'>
				<h1 class='text-2xl font-bold text-foreground sm:text-4xl'>Learning AI-native data science by building products</h1>
				<p class='max-w-2xl text-base text-muted-foreground'>
					I'm building full-stack products with AI tools, then doing data science on real user data. Everything is open: the code, the decisions, the mistakes.
				</p>
				
				<!-- CTAs -->
				<div class='flex flex-wrap gap-3'>
					<a
						href='#projects'
						class='inline-flex items-center gap-2 rounded-full bg-orange-500 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:bg-orange-400'
					>
						See Current Project
					</a>
					<a
						href='/build-log/contribute/'
						class='inline-flex items-center gap-2 rounded-full border border-border bg-primary-foreground px-5 py-2.5 text-sm font-medium text-foreground transition hover:-translate-y-0.5 hover:border-foreground/30'
					>
						Want to Contribute?
					</a>
				</div>
			</div>
		</section>

		<!-- ============================================ -->
		<!-- 80% SECTION: What I'm Building               -->
		<!-- ============================================ -->
		<section id='projects' class='space-y-6'>
			<div>
				<h2 class='text-2xl font-bold text-foreground'>What I'm Building</h2>
				<p class='mt-1 text-sm text-muted-foreground'>Live projects with real users and real data.</p>
			</div>

			<div class='space-y-4'>
				{projects.map((project) => (
					<ProjectCard project={project} variant='full' />
				))}
			</div>
		</section>

		<!-- ============================================ -->
		<!-- 80% SECTION: What I've Learned               -->
		<!-- ============================================ -->
		<section id='learnings' class='space-y-6'>
			<div>
				<h2 class='text-2xl font-bold text-foreground'>What I've Learned</h2>
				<p class='mt-1 text-sm text-muted-foreground'>Build logs, technical deep-dives, and lessons from shipping.</p>
			</div>

			<LearningsTimeline learnings={allLearnings} pageSize={10} client:load />
		</section>

		<!-- ============================================ -->
		<!-- 20% SECTION: Want to Contribute?             -->
		<!-- ============================================ -->
		<section id='contribute' class='border-t border-border pt-12'>
			<a 
				href='/build-log/contribute/' 
				class='group block rounded-2xl border border-border bg-primary-foreground p-6 shadow-lg shadow-black/5 transition hover:-translate-y-0.5 hover:border-orange-300 hover:shadow-xl'
			>
				<div class='flex flex-wrap items-center justify-between gap-4'>
					<div class='space-y-2'>
						<h2 class='text-xl font-semibold text-foreground group-hover:text-orange-500 transition'>Want to Contribute?</h2>
						<p class='text-sm text-muted-foreground'>
							Claim a task, open a PR, get code review, and ship. Real projects, real GitHub history.
						</p>
						<div class='flex items-center gap-4 text-sm'>
							<span><span class='font-bold text-foreground'>{totalContributors}</span> <span class='text-muted-foreground'>contributors</span></span>
							<span><span class='font-bold text-orange-500'>{openCount}</span> <span class='text-muted-foreground'>open tasks</span></span>
						</div>
					</div>
					<span class='inline-flex items-center gap-2 rounded-full bg-orange-500 px-5 py-2.5 text-sm font-semibold text-white shadow-sm transition group-hover:bg-orange-400'>
						See Open Tasks â†’
					</span>
				</div>
			</a>
		</section>
	</div>
</SiteLayout>


